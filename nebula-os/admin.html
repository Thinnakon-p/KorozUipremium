<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>404 Not Found</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;700&display=swap');
        
        /* Stealth Mode: Fake 404 Styles */
        .fake-404-body { background-color: #fff; color: #000; font-family: "Segoe UI", Tahoma, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .error-container { max-width: 600px; padding: 20px; }
        .error-code { font-size: 24px; font-weight: 500; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }

        /* Real Admin Styles */
        .admin-layout { font-family: 'Anuphan', sans-serif; background: #050505; color: #fff; display: none; }
        .glass { background: rgba(255,255,255,0.02); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.05); }
        .sidebar-active { background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; color: #ef4444; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        input, textarea { background: rgba(255,255,255,0.05) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; }
        .modal-bg { background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); }
    </style>
</head>
<body id="main-body" class="fake-404-body">

    <!-- FAKE 404 INTERFACE -->
    <div id="fake-404" class="error-container">
        <div class="error-code">404 Not Found</div>
        <p>The requested URL /admin.html was not found on this server.</p>
        <hr>
        <address>Apache/2.4.41 (Ubuntu) Server at nebula-system.io Port 443</address>
    </div>

    <!-- REAL ADMIN INTERFACE -->
    <div id="admin-ui" class="admin-layout min-h-screen w-full flex">
        <!-- Sidebar -->
        <aside class="w-72 glass border-r border-white/5 h-screen sticky top-0 flex flex-col p-8">
            <div class="text-2xl font-black italic mb-12 tracking-tighter text-red-500 flex items-center gap-2">
                <div class="w-8 h-8 bg-red-500 rounded flex items-center justify-center text-black not-italic text-sm">N</div>
                NEBULA <span class="text-[10px] bg-white/10 text-white px-2 py-0.5 rounded not-italic font-bold">CORE</span>
            </div>
            
            <nav class="flex-1 space-y-3">
                <button onclick="switchTab('users')" id="btn-users" class="w-full text-left p-4 rounded-2xl text-sm font-bold transition-all sidebar-active flex items-center gap-3">
                    Security & Users
                </button>
                <button onclick="switchTab('posts')" id="btn-posts" class="w-full text-left p-4 rounded-2xl text-sm font-bold transition-all opacity-50 hover:opacity-100 flex items-center gap-3">
                    Content Intelligence
                </button>
                <button onclick="switchTab('logs')" id="btn-logs" class="w-full text-left p-4 rounded-2xl text-sm font-bold transition-all opacity-50 hover:opacity-100 flex items-center gap-3">
                    Security Logs
                </button>
            </nav>

            <div class="pt-6 border-t border-white/5">
                <div id="admin-profile" class="mb-6 px-4">
                    <div class="text-xs font-bold text-red-500 uppercase tracking-widest">Active Admin</div>
                    <div id="admin-display-name" class="text-sm font-bold italic truncate">Commander</div>
                </div>
                <button onclick="handleLogout()" class="w-full p-4 rounded-2xl bg-white/5 text-xs font-bold text-zinc-500 hover:text-white hover:bg-red-500/20 transition-all">
                    Terminals Logout
                </button>
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 p-12 overflow-y-auto custom-scrollbar">
            <header class="flex justify-between items-start mb-12">
                <div>
                    <h1 id="tab-title" class="text-5xl font-black uppercase italic tracking-tighter text-white">Security Center</h1>
                    <p id="tab-desc" class="text-zinc-500 text-xs tracking-[0.3em] uppercase mt-2">Level 5 Clearance Required</p>
                </div>
                <div class="flex gap-4">
                    <div class="glass px-6 py-3 rounded-2xl text-center">
                        <div id="stat-users" class="text-xl font-black">0</div>
                        <div class="text-[8px] uppercase text-zinc-500 font-bold">Total Explorers</div>
                    </div>
                    <div class="glass px-6 py-3 rounded-2xl text-center border-red-500/20">
                        <div id="stat-banned" class="text-xl font-black text-red-500">0</div>
                        <div class="text-[8px] uppercase text-zinc-500 font-bold">Banned Terminals</div>
                    </div>
                </div>
            </header>

            <!-- Sections -->
            <section id="section-users" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in"></section>
            <section id="section-posts" class="hidden glass rounded-[2.5rem] overflow-hidden border-white/5 animate-fade-in"></section>
            <section id="section-logs" class="hidden glass rounded-[2.5rem] overflow-hidden border-white/5 animate-fade-in"></section>
        </main>
    </div>

    <!-- Global Modal -->
    <div id="modal-container" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-6 modal-bg">
        <div class="glass max-w-xl w-full rounded-[3rem] p-12 border-white/10 shadow-2xl relative">
            <button onclick="closeModal()" class="absolute top-8 right-8 text-zinc-500 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <div id="modal-content"></div>
        </div>
    </div>

    <script>
        // --- Security & Auth Check ---
        async function securityCheck() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (!session) return triggerAutoBan("Guest", "N/A");

            const { data: profile, error } = await supabaseClient.from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();

            if (error || !profile || !profile.is_admin) {
                return triggerAutoBan(session.user.id, session.user.email);
            }

            // If Admin, show UI
            document.title = "NEBULA COMMAND";
            document.getElementById('main-body').classList.remove('fake-404-body');
            document.getElementById('fake-404').classList.add('hidden');
            document.getElementById('admin-ui').style.display = 'flex';
            document.getElementById('admin-display-name').innerText = profile.username;
            
            initDashboard();
        }

        async function triggerAutoBan(userId, email) {
            console.error("INTRUSION DETECTED. INITIALIZING AUTO-BAN PROTOCOL.");
            
            let ip = "unknown";
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                ip = data.ip;
            } catch(e) {}

            // Log the event
            await supabaseClient.from('security_logs').insert([{
                user_id: userId === "Guest" ? null : userId,
                event_type: 'ADMIN_UNAUTHORIZED_ACCESS',
                ip_address: ip,
                metadata: { email, user_agent: navigator.userAgent, timestamp: new Date().toISOString() }
            }]);

            // Ban Account
            if (userId !== "Guest") {
                await supabaseClient.from('profiles').update({ 
                    is_banned: true, 
                    ban_reason: 'Automated AI Ban: Attempted Admin Gateway Breach' 
                }).eq('id', userId);
            }

            await supabaseClient.auth.signOut();
            // User remains stuck on the fake 404 page
        }

        // --- Dashboard Logic ---
        function initDashboard() {
            loadStats();
            loadUsers();
        }

        async function loadStats() {
            const { count: totalUsers } = await supabaseClient.from('profiles').select('*', { count: 'exact', head: true });
            const { count: bannedUsers } = await supabaseClient.from('profiles').select('*', { count: 'exact', head: true }).eq('is_banned', true);
            
            document.getElementById('stat-users').innerText = totalUsers || 0;
            document.getElementById('stat-banned').innerText = bannedUsers || 0;
        }

        function switchTab(tab) {
            const tabs = ['users', 'posts', 'logs'];
            const titles = { users: 'Security Center', posts: 'Content Intel', logs: 'Terminal Logs' };
            
            tabs.forEach(t => {
                document.getElementById(`section-${t}`).classList.toggle('hidden', t !== tab);
                document.getElementById(`btn-${t}`).classList.toggle('sidebar-active', t === tab);
                document.getElementById(`btn-${t}`).classList.toggle('opacity-50', t !== tab);
            });

            document.getElementById('tab-title').innerText = titles[tab];
            if (tab === 'users') loadUsers();
            if (tab === 'posts') loadPosts();
            if (tab === 'logs') loadLogs();
        }

        // --- User Actions ---
        async function loadUsers() {
            const { data: users } = await supabaseClient.from('profiles').select('*').order('created_at', { ascending: false });
            const container = document.getElementById('section-users');
            container.innerHTML = users.map(u => `
                <div class="glass p-8 rounded-[2.5rem] border-white/5 relative group transition-all hover:border-red-500/30 ${u.is_banned ? 'grayscale opacity-50' : ''}">
                    <div class="flex items-center gap-5 mb-6">
                        <div class="w-14 h-14 rounded-2xl bg-zinc-900 border border-white/10 flex items-center justify-center font-black text-xl text-red-500">
                            ${u.username[0].toUpperCase()}
                        </div>
                        <div class="flex-1">
                            <div class="font-black text-lg flex items-center gap-2">
                                ${u.username}
                                ${u.is_admin ? '<span class="bg-red-500 text-black text-[8px] px-1.5 rounded font-black">ROOT</span>' : ''}
                            </div>
                            <div class="text-[10px] text-zinc-600 font-mono truncate max-w-[150px]">${u.id}</div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="editUserModal('${u.id}')" class="w-full py-3 rounded-xl bg-white/5 text-[10px] font-bold uppercase tracking-widest hover:bg-white/10 transition-all">Edit Clearance</button>
                        <button onclick="toggleBan('${u.id}', ${u.is_banned})" class="w-full py-3 rounded-xl ${u.is_banned ? 'bg-emerald-500/10 text-emerald-500' : 'bg-red-500/10 text-red-500'} text-[10px] font-bold uppercase tracking-widest transition-all">
                            ${u.is_banned ? 'Restore Access' : 'Terminate Link'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function editUserModal(uid) {
            const { data: u } = await supabaseClient.from('profiles').select('*').eq('id', uid).single();
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <h2 class="text-3xl font-black italic uppercase mb-8">Override User Profile</h2>
                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest block mb-2">Username Identifier</label>
                        <input type="text" id="m-username" value="${u.username}" class="w-full rounded-2xl p-5 text-sm">
                    </div>
                    <div class="flex items-center gap-4 p-5 glass rounded-2xl border-white/10">
                        <input type="checkbox" id="m-admin" ${u.is_admin ? 'checked' : ''} class="w-6 h-6 accent-red-500">
                        <label for="m-admin" class="text-sm font-bold">Administrative Clearance (is_admin)</label>
                    </div>
                    <button onclick="updateUser('${u.id}')" class="w-full py-5 bg-red-500 text-black rounded-2xl font-black uppercase tracking-widest hover:bg-red-400 transition-all">Apply Overrides</button>
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        async function updateUser(uid) {
            const username = document.getElementById('m-username').value;
            const is_admin = document.getElementById('m-admin').checked;
            await supabaseClient.from('profiles').update({ username, is_admin }).eq('id', uid);
            closeModal();
            loadUsers();
        }

        async function toggleBan(uid, current) {
            if (confirm(`Execute Terminal ${current ? 'Restore' : 'Termination'}?`)) {
                await supabaseClient.from('profiles').update({ is_banned: !current, ban_reason: current ? null : 'Manual Admin Ban' }).eq('id', uid);
                loadUsers();
                loadStats();
            }
        }

        // --- Post Intelligence ---
        async function loadPosts() {
            const { data: posts } = await supabaseClient.from('posts').select(`*, profiles(username), likes(count), bookmarks(count)`).order('created_at', { ascending: false });
            const container = document.getElementById('section-posts');
            container.innerHTML = `
                <table class="w-full text-left">
                    <thead class="text-[10px] uppercase text-zinc-500 border-b border-white/5">
                        <tr><th class="p-8">Post Identifier</th><th class="p-8 text-center">Engagement</th><th class="p-8 text-right">Actions</th></tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        ${posts.map(p => `
                            <tr class="hover:bg-white/[0.02] transition-colors">
                                <td class="p-8">
                                    <div class="font-bold text-sm mb-1 line-clamp-1">${p.title || p.content.substring(0, 30)}</div>
                                    <div class="text-[10px] text-zinc-600 italic">by @${p.profiles?.username} â€¢ ${new Date(p.created_at).toLocaleString()}</div>
                                </td>
                                <td class="p-8">
                                    <div class="flex justify-center gap-6">
                                        <button onclick="viewEngagement('${p.id}', 'likes')" class="text-center group">
                                            <div class="text-xs font-black text-red-500 group-hover:scale-125 transition-all">${p.likes?.[0]?.count || 0}</div>
                                            <div class="text-[8px] font-bold text-zinc-600 uppercase">Likes</div>
                                        </button>
                                        <button onclick="viewEngagement('${p.id}', 'bookmarks')" class="text-center group">
                                            <div class="text-xs font-black text-blue-500 group-hover:scale-125 transition-all">${p.bookmarks?.[0]?.count || 0}</div>
                                            <div class="text-[8px] font-bold text-zinc-600 uppercase">Saves</div>
                                        </button>
                                    </div>
                                </td>
                                <td class="p-8 text-right">
                                    <button onclick="deletePost('${p.id}')" class="p-3 bg-red-500/10 text-red-500 rounded-xl hover:bg-red-500 hover:text-black transition-all">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function viewEngagement(pid, table) {
            const { data } = await supabaseClient.from(table).select('profiles(username)').eq('post_id', pid);
            const content = document.getElementById('modal-content');
            content.innerHTML = `
                <h2 class="text-2xl font-black italic uppercase mb-6">Signal Interaction: ${table}</h2>
                <div class="space-y-2 max-h-72 overflow-y-auto custom-scrollbar pr-4">
                    ${data.length > 0 ? data.map(i => `
                        <div class="p-4 glass rounded-2xl flex items-center gap-3 border-white/5">
                            <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center text-[10px]">@</div>
                            <span class="text-sm font-bold text-zinc-300">${i.profiles.username}</span>
                        </div>
                    `).join('') : '<div class="text-zinc-600 text-center py-10 italic">No signals found in this sector.</div>'}
                </div>
            `;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        async function loadLogs() {
            const { data: logs } = await supabaseClient.from('security_logs').select('*, profiles(username)').order('created_at', { ascending: false });
            const container = document.getElementById('section-logs');
            container.innerHTML = `
                <table class="w-full text-left">
                    <thead class="text-[10px] uppercase text-zinc-500 border-b border-white/5">
                        <tr><th class="p-8">Timestamp</th><th class="p-8">Event Type</th><th class="p-8">Source IP</th><th class="p-8">User Reference</th></tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        ${logs.map(l => `
                            <tr class="text-xs ${l.event_type.includes('UNAUTHORIZED') ? 'bg-red-500/5' : ''}">
                                <td class="p-8 text-zinc-500 font-mono">${new Date(l.created_at).toLocaleString()}</td>
                                <td class="p-8 font-bold ${l.event_type.includes('UNAUTHORIZED') ? 'text-red-500' : 'text-zinc-300'}">${l.event_type}</td>
                                <td class="p-8 text-zinc-400 font-mono">${l.ip_address}</td>
                                <td class="p-8 text-zinc-500">@${l.profiles?.username || 'Unknown/Guest'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function deletePost(pid) {
            if(confirm("Confirm Signal Deletion?")) {
                await supabaseClient.from('posts').delete().eq('id', pid);
                loadPosts();
            }
        }

        function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
        async function handleLogout() { await supabaseClient.auth.signOut(); window.location.href = 'index.html'; }

        // Startup
        securityCheck();
    </script>
</body>
</html>